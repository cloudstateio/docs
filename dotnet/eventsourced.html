<!DOCTYPE html>
<html lang="en">
  <head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Event sourcing :: Cloudstate Documentation</title>

<link rel="stylesheet" href="../_/css/site.css?v-01">
<link rel="shortcut icon" href="../_/img/favicon.ico" />

<meta itemprop="name" content="Event sourcing | Cloudstate Documentation">
<meta name="twitter:title" content="Event sourcing | Cloudstate Documentation">
<meta property="og:title" content="Event sourcing | Cloudstate Documentation" />

<meta property="og:type" content="website" />

<meta name="generator" content="Antora 2.3.3">

<link rel="canonical" href="https://cloudstate.io/docs/dotnet/eventsourced.html">
<meta property="og:url" content="https://cloudstate.io/docs/dotnet/eventsourced.html" />



<meta property="og:site_name" content="Cloudstate Documentation" />
<meta name="author" content="Cloudstate Documentation">
<meta itemprop="image" content="https://cloudstate.io/dist/images/cloudstate-distributed-state-management-for-serverless.png">
<meta name="twitter:image:src" content="https://cloudstate.io/dist/images/cloudstate-distributed-state-management-for-serverless.png">
<meta property="og:image" content="https://cloudstate.io/dist/images/cloudstate-distributed-state-management-for-serverless.png" />
<meta property="og:image:secure_url" content="https://cloudstate.io/dist/images/cloudstate-distributed-state-management-for-serverless.png" />
<!--Head Scripts -->
<script src="https://cdn.cookielaw.org/consent/a14b53db-7715-45da-be81-7fd0cafc385d.js" type="text/javascript" charset="UTF-8"></script>
<!--Head Scripts YouTube Embed-->
<script type="text/javascript">
	var ytID;
	function OptanonWrapper() {
		//find each YouTube embed and only load if cookies have been approved
		$( "a.yt-widget" ).each(function( index ) {
			var anchor = $(this);
			var ytURL = $(this).attr("href");
			var queryString = anchor[0].search;
			let params = new URLSearchParams(queryString);
			ytID = params.get("v");
			$(this).before('<div class="flex-video-wrapper"><div class="flex-video"><div id="yt-'+ytID+'" class="cookie-warning youtube-warning"><a class="optanon-allow-all">Accept cookies to view video</a><span>Alternatively you can watch the video <a href="'+ytURL+'" target="_blank">here on YouTube</a></span></div></div></div>');
			$(this).removeAttr("href").removeClass("yt-widget").addClass("yt-widget-hide");
		});

		$( ".youtube-warning" ).each(function( index ) {
			Optanon.InsertHtml('<iframe id="player" class="youtube-embed-player" src="//www.youtube.com/embed/'+ytID+'?rel=0&modestbranding=0" frameborder="0" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>', 'yt-'+ytID, null, {deleteSelectorContent: true}, 4);
		});
	}
</script>  </head>
  <body class="article  cloudstate">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://cloudstate.io">
        <img class="header-logo" src="../_/img/cloudstate-reverse.svg">
      </a>
      <a href="https://cloudstate.io/docs/" id="site-id" class="site-id">Documentation</a>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div id="lightbend-banner" class="lightbend-banner cloudstate full-width" data-category="OSS Lightbend Banner Impression" data-label="Cloudstate Banner Impression">
  <div class="wrapper">
    <div class="nav">
      <a class="banner-btn oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Enhance your apps with Lightbend [Button] - Cloudstate Banner" href="https://www.lightbend.com/lightbend-subscription?r=oss-banner-cloudstate" target="_blank">
        <span class="banner-btn-text">Enhance your apps with</span>
        <img class="lightbend-logo" src="../_/img/lightbend-logos/lightbend-reverse.svg" alt="Lightbend" title="Lightbend">
      </a>
      <div class="drop-down">
        <svg class="svg-chevon-circle-down" version="1.1" id="Chevron_circled_down" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve">
          <g>
            <circle cx="10" cy="10" r="9" />
            <path d="M12.505,8.698L10,11L7.494,8.698c-0.198-0.196-0.518-0.196-0.718,0c-0.197,0.196-0.197,0.515,0,0.71l2.864,2.807
            c0.199,0.196,0.52,0.196,0.717,0l2.864-2.807c0.199-0.195,0.198-0.514,0-0.71C13.024,8.502,12.704,8.502,12.505,8.698z" />
          </g>
        </svg>
        <div class="drop-down-content">
          <div class="lightbend-family">
            <a href="https://akka.io" class="akka oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Akka - Logo Tag Line - Cloudstate Banner">
              <img class="akka-full-color-logo" src="../_/img/lightbend-logos/akka-full-color.svg" alt="Akka by Lightbend" title="Akka by Lightbend">
            </a>
            <a href="https://cloudflow.io" class="cloudflow oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Cloudflow - Logo Tag Line - Cloudstate Banner">
              <img class="cloudflow-full-color-logo" src="../_/img/lightbend-logos/cloudflow-full-color.svg" alt="Cloudflow by Lightbend" title="Cloudflow by Lightbend">
            </a>
            <a href="https://www.lagomframework.com" class="lagom oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Lagom - Logo Tag Line - Cloudstate Banner">
              <img class="lagom-full-color-logo" src="../_/img/lightbend-logos/lagom-full-color.svg" alt="Lagom Framework by Lightbend" title="Lagom Framework by Lightbend">
            </a>
            <a href="https://www.playframework.com" class="play oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Play - Logo Tag Line - Cloudstate Banner">
              <img class="play-full-color-logo" src="../_/img/lightbend-logos/play-full-color.svg" alt="Play Framework by Lightbend" title="Play Framework by Lightbend">
            </a>
            <a href="https://www.scala-lang.org" class="scala oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Scala - Logo Tag Line - Cloudstate Banner">
              <img class="scala-full-color-logo" src="../_/img/lightbend-logos/scala-full-color.svg" alt="Scala by Lightbend" title="Scala by Lightbend">
            </a>
            <div class="cloudstate current">
              <img class="cloudstate-full-color-logo" src="../_/img/lightbend-logos/cloudstate-full-color.svg" alt="Cloudstate by Lightbend" title="Cloudstate by Lightbend">
              <span>Get developer assistance and expert support from Lightbend.</span>
              <a class="oss-track-link-label" data-category="OSS Lightbend Banner Clicks" data-label="Learn More [Button] - Cloudstate Banner" href="https://www.lightbend.com/lightbend-subscription?r=oss-banner-cloudstate" target="_blank">Learn More</a>
            </div>
          </div>
          <div class="title">The Lightbend Family</div>
        </div>
      </div>
    </div>
  </div>
</div>
      </div>
    </div>
  </nav>
</header>
<div class="main-wrapper">
<div class="navigation-container" data-component="" data-version="master">
  <aside class="navigation">
    <div class="panels">
<div class="navigation-menu is-active" data-panel="menu">
  <nav class="nav-menu">
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="../index.html">Introduction</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../stateless-limitations.html">Current limitations of Serverless platforms</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../crud-limitations.html">Rethinking CRUD</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../cloudstate-solution.html">The Cloudstate solution</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../working.html">Working with Cloudstate</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../examples.html">Example Applications</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="../concepts/index.html">Important concepts</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../concepts/glossary.html">Glossary</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../concepts/grpc.html">gRPC</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../concepts/eventsourced.html">Event sourcing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../concepts/crdts.html">Conflict-free replicated data types</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../concepts/effects.html">Forwarding and effects</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="../develop/index.html">Developing Cloudstate services</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../develop/prerequisites.html">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../develop/install.html">Installing Cloudstate</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../develop/gke.html">Run on GKE</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../develop/examples.html">Available Cloudstate examples</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../develop/tutorial.html">The shopping cart tutorial</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="../dart/index.html">Implementing in Dart</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../dart/gettingstarted.html">Getting started</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../dart/eventsourced.html">Event sourcing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../dart/crdt.html">Conflict-free Replicated Data Types</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../dart/actions.html">Actions</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../dart/examples.html">Examples</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../dart/serialization.html">Serialization</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../old-dart/index.html">Implementing in Dart</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="../go/index.html">Implementing in Go</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../go/gettingstarted.html">Getting started</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../go/eventsourced.html">Event sourcing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../go/crdt.html">Conflict-free Replicated Data Types</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../go/effects.html">Forwarding and effects</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../go/serialization.html">Serialization</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../go/api.html">API docs</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="../java/index.html">Implementing in Java</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../java/getting-started.html">Getting started</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../java/eventsourced.html">Event sourcing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../java/crdt.html">Conflict-free Replicated Data Types</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../java/effects.html">Forwarding and effects</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../java/serialization.html">Serialization</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../java/api.html">Java API docs</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="../javascript/index.html">Implementing in JavaScript</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../javascript/getting-started.html">Getting started</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../javascript/eventsourced.html">Event sourcing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../javascript/crdt.html">Conflict-free Replicated Data Types</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../javascript/effects.html">Forwarding and effects</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../javascript/serialization.html">Serialization</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../javascript/api.html">JavaScript API docs</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="../kotlin/index.html">Implementing in Kotlin</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../kotlin/gettingstarted.html">Getting started</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../kotlin/eventsourced.html">Event sourcing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../kotlin/crdt.html">Conflict-free Replicated Data Types</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="../kotlin/dsl.html">DSL</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../kotlin/eventsourceddsl.html">Event sourcing</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../kotlin/crdtdsl.html">Conflict-free Replicated Data Types</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../kotlin/examples.html">Examples</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../kotlin/serialization.html">Serialization</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="../python/index.html">Implementing in Python</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../python/gettingstarted.html">Getting started</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../old-python/index.html">Implementing in Python</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="../springboot/index.html">Implementing in Spring Boot</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../springboot/gettingstarted.html">Getting started</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../springboot/configuration.html">Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../springboot/cdi.html">Context Injection</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../springboot/conventions.html">Conventions and Restrictions</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../springboot/examples.html">Examples</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="index.html">Implementing in .Net</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="gettingstarted.html">Getting started</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="eventsourced.html">Event sourcing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="crdt.html">Conflict-free Replicated Data Types</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="actions.html">Actions</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="examples.html">Examples</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="serialization.html">Serialization</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../old-dotnet/index.html">Implementing in .Net</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="../deploy/index.html">Deploying to production systems</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../deploy/install-production.html">Setting up a production cluster</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../deploy/deploying.html">Deploying stateful services</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="../deploy/stateful-stores.html">Stateful stores</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../deploy/cassandra.html">Cassandra</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../deploy/postgresql.html">PostgresSQL</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../deploy/inmemory.html">In memory store</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../deploy/monitoring.html">Monitoring</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../deploy/autoscaling.html">Autoscaling</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../deploy/security.html">Security</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="../contribute/index.html">Contributing to the project</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../contribute/architecture.html">Architecture</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../contribute/getting-started.html">Getting started</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../contribute/build-native.html">Building native images</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../contribute/serialization.html">Serialization conventions</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../contribute/language-support.html">Language support</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../contribute/knative-integration.html">Knative integration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../contribute/graalvm-integration.html">GraalVM integration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../contribute/testing.html">Testing</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="navigation-explore" data-panel="explore">
  <div class="context">
    <span class="title">Cloudstate</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Cloudstate</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
  <main class="main">
<div class="toolbar" role="navigation">
  <button class="navigation-toggle"></button>
<nav class="crumbs" aria-label="breadcrumbs">
  <ul>
    <li class="crumb"><a href="index.html">Implementing in .Net</a></li>
    <li class="crumb"><a href="eventsourced.html">Event sourcing</a></li>
  </ul>
</nav>
</div>
    <div class="col-content">
<article id="page-content" class="doc">
			<h1>Event sourcing</h1>

		<fieldset class="supergroup-switch">


		</fieldset>

		<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This page documents how to implement Cloudstate event sourced entities in .Net C#.
For information on what Cloudstate event sourced entities are, please read the general <a href="../concepts/eventsourced.html" class="page">Event sourcing</a> documentation first.</p>
</div>
<div class="paragraph">
<p>An event sourced entity can be created by annotating it with the <code>[EventSourcedEntity]</code> attribute.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cs hljs" data-lang="cs">namespace EventSourced.ShoppingCart
{
    [EventSourcedEntity]
    public class ShoppingCartEntity
    {
        // ...
    }</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="persistence-types-and-serialization"><a class="anchor" href="#persistence-types-and-serialization"></a>Persistence types and serialization</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Event sourced entities persist events and snapshots, and these need to be serialized when persisted.
The most straight forward way to persist events and snapshots is to use protobufs.
Cloudstate will automatically detect if an emitted event is a protobuf, and serialize it as such.
For other serialization options, including JSON, see <a href="serialization.html" class="page">Serialization</a>.</p>
</div>
<div class="paragraph">
<p>While protobufs are the recommended format for persisting events, it is recommended that you do not persist your services protobuf messages, rather, you should create new messages, even if they are identical to the services.
While this may introduce some overhead in needing to convert from one type to the other, the reason for doing this is that it will allow the services public interface to evolve independently from its data storage format, which should be private.</p>
</div>
<div class="paragraph">
<p>For our shopping cart example, we&#8217;ll create a new file called <code>domain.proto</code>, the name domain is selected to indicate that these are my applications domain objects:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-protobuf hljs" data-lang="protobuf">syntax = "proto3";

package example.shoppingcart.domain;

option java_package = "com.example";

message LineItem {
    string productId = 1;
    string name = 2;
    int32 quantity = 3;
}

message ItemAdded {
    LineItem item = 1;
}

message ItemRemoved {
    string productId = 1;
}

message CheckedOut {}

message Cart {
    repeated LineItem items = 1;
    bool checkedout = 2;
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="state"><a class="anchor" href="#state"></a>State</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Each entity should store its state locally in a mutable variable, either a mutable field or a multiple structure such as a collection.
For our shopping cart, the state is a dictionary of product ids to products, so we&#8217;ll create a dictionary to contain that:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cs hljs" data-lang="cs">Dictionary&lt;String, Com.Example.Shoppingcart.LineItem&gt; Cart { get; }</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="constructing"><a class="anchor" href="#constructing"></a>Constructing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>While you don&#8217;t necessarily need to define a constructor, you can define one and have that context and EntityId injected in.
Use the <code>[EntityId]</code> attribute to indicate where the EntityId value will be set.</p>
</div>
<div class="paragraph">
<p>The constructor below shows having the entity id injected:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cs hljs" data-lang="cs">public ShoppingCartEntity([EntityId]String entityId)
{
    EntityId = entityId;
    Cart = new Dictionary&lt;string, Com.Example.Shoppingcart.LineItem&gt;();
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="handling-commands"><a class="anchor" href="#handling-commands"></a>Handling commands</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Command handlers can be declared by annotating a method with <code>[CommandHandler]</code> attribute.
They take a context class of type <code>ICommandContext</code>.</p>
</div>
<div class="paragraph">
<p>By default, the name of the command that the method handles will be the name of the method with the first letter capitalized.
So, a method called <code>GetCart</code> will handle gRPC service call command named <code>GetCart</code>.</p>
</div>
<div class="paragraph">
<p>The return type of the command handler must be the output type for the gRPC service call, this will be sent as the reply.</p>
</div>
<div class="paragraph">
<p>The following shows the implementation of the <code>GetCart</code> command handler.
This command handler is a read-only command handler, it doesn&#8217;t emit any events, it just returns some state:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cs hljs" data-lang="cs">[CommandHandler]
public Com.Example.Shoppingcart.Cart GetCart()
{
    var cart = new Com.Example.Shoppingcart.Cart();
    cart.Items.AddRange(Cart.Values);
    return cart;
}</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="emitting-events"><a class="anchor" href="#emitting-events"></a>Emitting events</h3>
<div class="paragraph">
<p>Commands that modify the state may do so by emitting events.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The <strong>only</strong> way a command handler may modify its state is by emitting an event. Any modifications made directly to the state from the command handler will not be persisted, and when the entity is passivated and next reloaded, those modifications will not be present.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A command handler may emit an event by taking in a <code>ICommandContext</code> parameter, and invoking the <code>emit</code> method on it.
Invoking <code>emit</code> will immediately invoke the associated event handler for that event - this both validates that the event can be applied to the current state, as well as updates the state so that subsequent processing in the command handler can use it.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s an example of a command handler that emits an event:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cs hljs" data-lang="cs">[CommandHandler]
public Empty AddItem(Com.Example.Shoppingcart.AddLineItem item, ICommandContext ctx)
{
    if (item.Quantity &lt;= 0)
    {
        ctx.Fail("Cannot add negative quantity of to item" + item.ProductId);
    }
    ctx.Emit(
        new ItemAdded()
        {
            Item = new LineItem()
            {
                ProductId = item.ProductId,
                Quantity = item.Quantity
            }
        }
    );
    return new Empty();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command handler also validates the command, ensuring the quantity items added is greater than zero.
Invoking <code>ctx.fail</code> fails the command - this method throws so there&#8217;s no need to explicitly throw an exception.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="handling-events"><a class="anchor" href="#handling-events"></a>Handling events</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Event handlers are invoked at two points, when restoring entities from the journal, before any commands are handled, and each time a new event is emitted.
An event handlers responsibility is to update the state of the entity according to the event.
Event handlers are the only place where its safe to mutate the state of the entity at all.</p>
</div>
<div class="paragraph">
<p>Event handlers are declared by annotating a method with <code>[EventHandler(typeof(Type))]</code> attribute.
They take a context class of type <code>IEventBehaviorContext</code>.</p>
</div>
<div class="paragraph">
<p>Event handlers are differentiated by the type of event they handle in <code>EventHandler</code> attribute.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s an example event handler for the <code>ItemRemoved</code> event.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cs hljs" data-lang="cs">[EventHandler(typeof(ItemRemoved))]
public void itemRemoved(ItemRemoved itemRemoved, IEventBehaviorContext c)
{
    Cart.Remove(itemRemoved.ProductId);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="producing-and-handling-snapshots"><a class="anchor" href="#producing-and-handling-snapshots"></a>Producing and handling snapshots</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Snapshots are an important optimisation for event sourced entities that may contain many events, to ensure that they can be loaded quickly even when they have very long journals.
To produce a snapshot, a method annotated with <code>[Snapshot]</code> attribute must be declared.
It takes a context class of type <code>ISnapshotContext</code>, and must return a snapshot of the current state in serializable form.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cs hljs" data-lang="cs">[Snapshot]
public Cart Snapshot()
{
    var cart = new Cart();
    cart.Items.AddRange(Cart.Select(x =&gt; Convert(x.Value)));
    return cart;
}

Com.Example.Shoppingcart.LineItem Convert(LineItem item)
{
    var lineItem = new Com.Example.Shoppingcart.LineItem();
    lineItem.ProductId = item.ProductId;
    lineItem.Name = item.Name;
    lineItem.Quantity = item.Quantity;
    return lineItem;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the entity is loaded again, the snapshot will first be loaded before any other events are received, and passed to a snapshot handler.
Snapshot handlers are declare by annotating a method with <code>[SnapshotHandler]</code> attribute, and it can take a context class of type <code>ISnapshotContext</code>.</p>
</div>
<div class="paragraph">
<p>Multiple snapshot handlers may be defined to handle multiple different types of snapshots, the type matching is done in the same way as for events.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cs hljs" data-lang="cs">[SnapshotHandler]
public void HandleSnapshot(Cart cart)
{
    Cart.Clear();
    foreach (LineItem item in cart.Items)
    {
        Cart.Add(item.ProductId, Convert(item));
    }
}

LineItem Convert(Com.Example.Shoppingcart.LineItem item) =&gt;
new LineItem()
{
    ProductId = item.ProductId,
    Name = item.Name,
    Quantity = item.Quantity
};</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="registering-the-entity"><a class="anchor" href="#registering-the-entity"></a>Registering the entity</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Once you&#8217;ve created your entity, you can register it with the <code>CloudState</code> server, by invoking the <code>RegisterEventSourcedEntity&lt;EntityType&gt;</code> method.
In addition to passing the protobuf descriptors and any other additional descriptors you use.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cs hljs" data-lang="cs">var state = new CloudState.CSharpSupport.CloudState()
        .RegisterEventSourcedEntity&lt;ShoppingCartEntity&gt;(
            Com.Example.Shoppingcart.ShoppingCart.Descriptor,
            Com.Example.Shoppingcart.Persistence.DomainReflection.Descriptor
        );

await state.StartAsync();</code></pre>
</div>
</div>
<div class="paragraph">
<p>The complete code for our entity class would look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cs hljs" data-lang="cs">using System;
using System.Collections.Generic;
using System.Diagnostics.CodeAnalysis;
using System.Linq;
using CloudState.CSharpSupport.Attributes;
using CloudState.CSharpSupport.Attributes.EventSourced;
using CloudState.CSharpSupport.Interfaces.EventSourced.Contexts;
using Com.Example.Shoppingcart.Persistence;
using Google.Protobuf.WellKnownTypes;

namespace EventSourced.ShoppingCart
{
    [EventSourcedEntity]
    [SuppressMessage("ReSharper", "ClassNeverInstantiated.Global")]
    [SuppressMessage("ReSharper", "UnusedMember.Global")]
    public class ShoppingCartEntity
    {
        String EntityId { get; }

        Dictionary&lt;String, Com.Example.Shoppingcart.LineItem&gt; Cart { get; }

        public ShoppingCartEntity([EntityId]String entityId)
        {
            EntityId = entityId;
            Cart = new Dictionary&lt;string, Com.Example.Shoppingcart.LineItem&gt;();
        }

        [Snapshot]
        public Cart Snapshot()
        {
            var cart = new Cart();
            cart.Items.AddRange(Cart.Select(x =&gt; Convert(x.Value)));
            return cart;
        }

        [SnapshotHandler]
        public void HandleSnapshot(Cart cart)
        {
            Cart.Clear();
            foreach (LineItem item in cart.Items)
            {
                Cart.Add(item.ProductId, Convert(item));
            }
        }

        [EventHandler(typeof(ItemAdded))]
        public void ItemAdded(ItemAdded itemAdded)
        {
            Cart.TryGetValue(itemAdded.Item.ProductId, out var item);
            if (item == null)
            {
                item = Convert(itemAdded.Item);
                Cart.Add(item.ProductId, item);
            }
            else
            {
                item = new Com.Example.Shoppingcart.LineItem(item)
                {
                    Quantity = item.Quantity + itemAdded.Item.Quantity
                };
                Cart[item.ProductId] = item;
            }
        }

        [EventHandler(typeof(ItemRemoved))]
        public void itemRemoved(ItemRemoved itemRemoved, IEventBehaviorContext c)
        {
            Cart.Remove(itemRemoved.ProductId);
        }

        [CommandHandler]
        public Com.Example.Shoppingcart.Cart GetCart()
        {
            var cart = new Com.Example.Shoppingcart.Cart();
            cart.Items.AddRange(Cart.Values);
            return cart;
        }

        [CommandHandler]
        public Empty AddItem(Com.Example.Shoppingcart.AddLineItem item, ICommandContext ctx)
        {
            if (item.Quantity &lt;= 0)
            {
                ctx.Fail("Cannot add negative quantity of to item" + item.ProductId);
            }
            ctx.Emit(
                new ItemAdded()
                {
                    Item = new LineItem()
                    {
                        ProductId = item.ProductId,
                        Quantity = item.Quantity
                    }
                }
            );
            return new Empty();
        }

        Com.Example.Shoppingcart.LineItem Convert(LineItem item)
        {
            var lineItem = new Com.Example.Shoppingcart.LineItem();
            lineItem.ProductId = item.ProductId;
            lineItem.Name = item.Name;
            lineItem.Quantity = item.Quantity;
            return lineItem;
        }

        LineItem Convert(Com.Example.Shoppingcart.LineItem item) =&gt;
          new LineItem()
          {
              ProductId = item.ProductId,
              Name = item.Name,
              Quantity = item.Quantity
          };

    }
}</code></pre>
</div>
</div>
</div>
</div>
		<nav class="pagination">
  <span class="prev"><a href="gettingstarted.html">Getting started</a></span>
  <span class="next"><a href="crdt.html">Conflict-free Replicated Data Types</a></span>
</nav>
</article>
<aside class="toc sidebar">
  <div class="toc-menu"></div>
</aside>
    </div>
<div class="main-footer">
  <div class="page-source">
Found an error in this documentation? Please feel free to <a href="https://github.com/cloudstateio/dotnet-support/edit/master/docs/src/modules/dotnet/pages/eventsourced.adoc">edit this page</a> and contribute a pull request.
</div>
  <div class="footer-box">
    <footer class="footer">
      <div class="footer-logo"><a href="https://cloudstate.io"><img src="../_/img/cloudstate-color.svg"></a></div>
      <div class="footer-content">Â© Cloudstate <script>document.write(new Date().getFullYear());</script> | <a href="https:///cloudstate.io/privacy/">Privacy Policy</a> | <a class="optanon-toggle-display">Cookie Settings</a></div>
    </footer>
  </div>
</div>
  </main>
</div>
<!--Footer Scripts Global-->
<script src="../_/js/site.js"></script>
<script src="../_/js/vendor/highlight.js"></script>
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="../_/js/vendor/groups.js"></script>
<script>hljs.initHighlighting()</script>
<script src="../_/js/vendor/jquery.waypoints.min.js"></script>
<script src="../_/js/vendor/inview.min.js"></script>

<script>
(function($) {
	$(function() {
		
		var pageViewedTriggerElement = '#page-content';
		//override #page-content if a custom trigger is present in page
		if($("#page-viewed-trigger").length){
			pageViewedTriggerElement = '#page-viewed-trigger';
		}

		var inview = new Waypoint.Inview({
			element: $(pageViewedTriggerElement)[0],
				entered: function(direction) {
				//fire custom Jquery event that Marketo can listen for
				$.event.trigger({
					type: "pageContentViewed"
				});
			}
		})

	});
})(jQuery);
</script>

<!--Marketo-->
<script>

    //store munchkin status to use in other functions
    var munchkinLive = false;

    //marketo munchkin
    (function() {
      var didInit = false;
      function initMunchkin() {
        if(didInit === false) {
          didInit = true;
          Munchkin.init('558-NCX-702', { 'asyncOnly': true, 'disableClickDelay': true });
          munchkinLive = true;
        }
      }
      var s = document.createElement('script');
      s.type = 'text/javascript';
      s.src = '//munchkin.marketo.net/munchkin.js';
      s.onreadystatechange = function() {
        if (this.readyState == 'complete' || this.readyState == 'loaded') {
          initMunchkin();
        }
      };
      s.onload = initMunchkin;
      document.getElementsByTagName('head')[0].appendChild(s);
    })();


    //wait for jquery as we use a custom jquery event, triggered by waypoint.
    (function($) {
      $(function() {
        var pageViewed = false;
        
        $(document).on("pageContentViewed", handlePageContentViewed);
        
        function handlePageContentViewed(e) {
          var viewedPagePath = "/viewed"+window.location.pathname;
          if(!pageViewed && munchkinLive){
            Munchkin.munchkinFunction('visitWebPage', {
              'url': viewedPagePath
              }
            );
            pageViewed = true;
          }
        };


      });
    })(jQuery);

</script><!--Footer Scripts Cloudstate-->
<!-- Google Tag Manager -->
<script type="text/plain" class="optanon-category-2">(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-WWL9BXX');</script>
<!-- End Google Tag Manager -->
  </body>
</html>
