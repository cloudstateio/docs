<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>CloudState serialization convention · CloudState</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content='CloudState Documentation'/>
<link rel="canonical" href="https://cloudstate.io/docs/developer/language-support/serialization.html"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:100normal,100italic,300normal,300italic,400normal,400italic,500normal,500italic,700normal,700italic,900normal,900italicc" rel="stylesheet" type="text/css"/>

<!-- OneTrust Cookies Consent Notice start -->
<script type="text/javascript">
(function(w,d,s){if(w.location.protocol!="file:"){var f=d.getElementsByTagName(s)[0],j=d.createElement(s);
j.async=true;j.src="https://optanon.blob.core.windows.net/consent/a14b53db-7715-45da-be81-7fd0cafc385d.js";
j.charset="UTF-8";f.parentNode.insertBefore(j,f);}})(window,document,"script");</script>
<!-- OneTrust Cookies Consent Notice end -->

<!-- Google Tag Manager -->
<script type="text/plain" class="optanon-category-2">(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-WWL9BXX');</script>
<!-- End Google Tag Manager -->

<script type="text/javascript" src="../../lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="../../js/page.js"></script>
<script type="text/javascript" src="../../js/warnOldVersion.js"></script>
<script type="text/javascript" src="../../js/groups.js"></script>
<link rel="stylesheet" type="text/css" href="../../lib/foundation/dist/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="../../css/page.css"/>

<link rel="icon" type="image/x-icon" href="../../../favicon.ico">
</head>

<body>
<div class="off-canvas-wrapper">
<div class="off-canvas-wrapper-inner" data-off-canvas-wrapper>

<div class="off-canvas position-left" id="off-canvas-menu" data-off-canvas>
<nav class="off-canvas-nav">
<div class="nav-home">
<a href="../../index.html" >
<img src="../../images/cloudstate-horizontal-color.svg" alt="CloudState"/>
</a>
</div>
<div class="nav-toc">
<ul>
  <li><a href="../../user/index.html" class="page">Using CloudState</a>
  <ul>
    <li><a href="../../user/quickstart.html" class="page">Quickstart</a></li>
    <li><a href="../../user/features/index.html" class="page">Overview</a></li>
    <li><a href="../../user/lang/index.html" class="page">Languages</a></li>
    <li><a href="../../user/deployment/index.html" class="page">Deploying applications</a></li>
  </ul></li>
  <li><a href="../../spec/index.html" class="page">Protocol Specification</a></li>
  <li><a href="../../developer/index.html" class="page">Content for developers of CloudState</a>
  <ul>
    <li><a href="../../developer/thebuild.html" class="page">The CloudState Build</a></li>
    <li><a href="../../developer/language-support/index.html" class="page">Language support</a></li>
  </ul></li>
</ul>
</div>
</nav>
</div>

<div class="off-canvas-content" data-off-canvas-content>

<header class="site-header expanded row">
<div class="small-12 column">
<a href="#" class="off-canvas-toggle hide-for-medium" data-toggle="off-canvas-menu"><svg class="svg-icon svg-icon-menu" version="1.1" id="Menu" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve"> <path class="svg-icon-menu-path" fill="#53CDEC" d="M16.4,9H3.6C3.048,9,3,9.447,3,10c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,9.447,16.952,9,16.4,9z M16.4,13
H3.6C3.048,13,3,13.447,3,14c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,13.447,16.952,13,16.4,13z M3.6,7H16.4
C16.952,7,17,6.553,17,6c0-0.553-0.048-1-0.6-1H3.6C3.048,5,3,5.447,3,6C3,6.553,3.048,7,3.6,7z"/></svg>
</a>
<div class="title"><a href="../../.."><img src="../../images/cloudstate-horizontal-white.svg" alt="CloudState"/></a></div>
</div>
</header>

<div class="expanded row">

<div class="medium-3 large-2 show-for-medium column site-nav-container">
<nav class="site-nav">
<div class="nav-home">
<a href="../../index.html" >
<img src="../../images/cloudstate-horizontal-color.svg" alt="CloudState"/>
</a>
</div>
<div class="nav-toc">
<ul>
  <li><a href="../../user/index.html" class="page">Using CloudState</a>
  <ul>
    <li><a href="../../user/quickstart.html" class="page">Quickstart</a></li>
    <li><a href="../../user/features/index.html" class="page">Overview</a></li>
    <li><a href="../../user/lang/index.html" class="page">Languages</a></li>
    <li><a href="../../user/deployment/index.html" class="page">Deploying applications</a></li>
  </ul></li>
  <li><a href="../../spec/index.html" class="page">Protocol Specification</a></li>
  <li><a href="../../developer/index.html" class="page">Content for developers of CloudState</a>
  <ul>
    <li><a href="../../developer/thebuild.html" class="page">The CloudState Build</a></li>
    <li><a href="../../developer/language-support/index.html" class="page">Language support</a></li>
  </ul></li>
</ul>
</div>
</nav>
</div>

<div class="small-12 medium-9 large-10 column">
<section class="site-content">

<span id="version-warning"></span>

<div class="page-header row">
<div class="medium-12 show-for-medium column">
<div class="nav-breadcrumbs">
<ul>
  <li><a href="../../index.html">CloudState</a></li>
  <li><a href="../../developer/index.html">Content for developers of CloudState</a></li>
  <li><a href="../../developer/language-support/index.html">Language support</a></li>
  <li>CloudState serialization convention</li>
</ul>
</div>
</div>
</div>

<div class="page-content row">
<div class="small-12 large-9 column" id="docs">
<h1><a href="#cloudstate-serialization-convention" name="cloudstate-serialization-convention" class="anchor"><span class="anchor-link"></span></a>CloudState serialization convention</h1>
<p>There are several cases in CloudState where user provided values need to be serialized. Given CloudState&rsquo;s dependence on gRPC, protobuf is an obvious serialization format, however, it&rsquo;s not always convenient. For example, if protobufs were the only supported format, it would not be possible to use strings as keys in an ORMap, instead users would have to create a protobuf message that wrapped a string, and use that instead.</p>
<p>User function libraries are therefore encouraged to support a variety of primitive types, according to what&rsquo;s available in their language. JSON is also a popular and convenient serialization format in some situations, and this may supported too.</p>
<p>User provided values in CloudState are serialized to <a href="https://developers.google.com/protocol-buffers/docs/proto3#any">protobuf <code>Any</code></a> values. These contain a <code>type_url</code> <code>string</code> field that identify the protobuf type, along with a <code>value</code> <code>bytes</code> value for the serialized bytes. While there&rsquo;s nothing technically stopping anything being put in either of the fields, such as a UTF8 encoded string or JSON, the <code>bytes</code> are meant to be a valid protobuf, and the <code>type_url</code> is meant to refer to a protobuf type. To support the serialization of primitive and JSON values in a way that is as consistent as possible with the intentions behind <code>Any</code>, CloudState has defined convention for achieving this.</p>
<h2><a href="#primitive-values" name="primitive-values" class="anchor"><span class="anchor-link"></span></a>Primitive values</h2>
<p>Serialized primitive values have a <code>type_url</code> prefix of <code>p.cloudstate.io</code>. The path of the URL is the protobuf name of the primitive. So, for example, the <code>type_url</code> of a serialized string is <code>p.cloudstate.io/string</code>, while for a serialized boolean, it is <code>p.cloudstate.io/bool</code>.</p>
<p>The <code>value</code> field contains a message that is serialized using the following schema:</p>
<pre class="prettyprint"><code class="language-proto">syntax = &quot;proto3&quot;;
message Primitive {
  &lt;type&gt; value = 1;
}
</code></pre>
<p>Where <code>&lt;type&gt;</code> is the type of the primitive, eg <code>string</code>. Implementations may define messages to represent these, but in most cases this is not necessary, serializing and deserializing the above message can be done manually using the libraries provided by the protobuf support in a given language.</p>
<h3><a href="#primitive-value-stability" name="primitive-value-stability" class="anchor"><span class="anchor-link"></span></a>Primitive value stability</h3>
<p>Since these values are often used as keys in maps and elements in sets, the stability of the encoded form is important. While the protobuf spec does not make any guarantees on serialization stability, protobuf implementations are free to guarantee stability of their serialized form, and so it&rsquo;s important that the implementation used to encode the above messages is stable. This means, no additional fields may be included in the message, and if the primitive value is the default value for that type (for example, for <code>string</code>, the empty string, or for any number, zero), the encoded message must be an empty byte string.</p>
<h2><a href="#json-values" name="json-values" class="anchor"><span class="anchor-link"></span></a>JSON values</h2>
<p>Serialized JSON values have a <code>type_url</code> prefix of <code>json.cloudstate.io</code>, and a path determined using a language specific mechanism, for example, in statically typed languages, it may be a fully qualified class name, in dynamically type languages, it may come from a field in the object, such as <code>type</code>. Typically, the type will be important even in dynamically typed languages when serializing event sourced events, to determine which event handler should be invoked to handle a particular event.</p>
<p>The <code>value</code> field contains a message that is serialized using the following schema:</p>
<pre class="prettyprint"><code class="language-proto">syntax = &quot;proto3&quot;;
message Json {
  bytes json = 1;
}
</code></pre>
<p>The UTF8 encoded serialized JSON is placed in the <code>json</code> field of the message above. This encoding is intentionally identical to using a <code>string</code> typed <code>json</code> field instead, both will yield exactly the same bytes for the same JSON. It is also identical to the primitive encoding for <code>string</code> and <code>bytes</code>, and so implementations may simply reuse that.</p>
<h3><a href="#serialized-json-value-stability" name="serialized-json-value-stability" class="anchor"><span class="anchor-link"></span></a>Serialized JSON value stability</h3>
<p>As with primitive values, the stability of the encoded form is important. Libraries are encouraged to use JSON encoders that produce a stable output for logically equal inputs. CloudState does not put any requirements on how to achieve stable serialization, however many languages have libraries that do produce a canonical JSON representation of values. In the absence of such a library, the following considerations need to be remembered:</p>
<ul>
  <li>The order of fields must not change for two equivalent objects - lexicographically sorting them is one way to achieve this.</li>
  <li>The whitespace in the representation must be consistent (typically, no whitespace is best).</li>
  <li>The serialization of equal numbers must be consistent (eg, if a number is equal to 1, it should either encode to 1, or 1.0, but not both).</li>
</ul>
<div class="source-github">
The source code for this page can be found <a href="https://github.com/cloudstateio/cloudstate/tree/master/docs/src/main/paradox/developer/language-support/serialization.md">here</a>.
</div>

</div>
<div class="large-3 show-for-large column" data-sticky-container>
<nav class="sidebar sticky" data-sticky data-anchor="docs" data-sticky-on="large">
<div class="page-nav">
<div class="nav-title">On this page:</div>
<div class="nav-toc">
<ul>
  <li><a href="../../developer/language-support/serialization.html#cloudstate-serialization-convention" class="header">CloudState serialization convention</a>
  <ul>
    <li><a href="../../developer/language-support/serialization.html#primitive-values" class="header">Primitive values</a></li>
    <li><a href="../../developer/language-support/serialization.html#json-values" class="header">JSON values</a></li>
  </ul></li>
</ul>
</div>
</div>
</nav>
</div>
</div>

</section>
</div>

</div>

<footer class="site-footer">

<a href="../../.."><img src="../../images/cloudstate-stacked-white.svg"></a>
<p>© CloudState 2019 | <a href="../../../privacy/">Privacy Policy</a> | <a class="optanon-toggle-display">Cookie Settings</a></p>

</footer>

</div>
</div>
</div>
</body>

<script type="text/javascript" src="../../lib/foundation/dist/foundation.min.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="../../js/magellan.js"></script>

<style type="text/css">@import "../../lib/prettify/prettify.css";</style>
<script type="text/javascript" src="../../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">jQuery(function(){window.prettyPrint && prettyPrint()});</script>


</html>
